{% extends 'base.html' %}

{% load hhphelpers %}

{% block js %}

<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.3/themes/base/jquery-ui.css" type="text/css" media="all" /> 
<link rel="stylesheet" href="http://static.jquery.com/ui/css/demo-docs-theme/ui.theme.css" type="text/css" media="all" /> 

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript" ></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.3/jquery-ui.min.js" type="text/javascript"></script>
<script src="http://jquery-ui.googlecode.com/svn/tags/latest/external/jquery.bgiframe-2.1.1.js" type="text/javascript"></script> 
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.3/i18n/jquery-ui-i18n.min.js" type="text/javascript"></script> 

<style type="text/css">
	#sessions-menu
	{
		width: 200px;
		position: absolute;
		top: 25px;
		left: 20px;
		background-color: #efcec5;
	}
	
	#sessions-add, .sessions-session
	{
		background-color: #efcec5;
		border: 1px solid #fff;
		padding: 2px;
	}
	
	#sessions-add
	{
		background-color: #ee9d87;
		border: 1px solid #fff;
	}
	
	#sessions-menu a
	{
		font-weight: bold;
		color: #fff;
	}
	
	#sessions-menu a.delete { float: right; }
	
	#sessions-menu a:hover, .session-active
	{
		font-weight: bold;
		color: #e85631 !important;
	}
	
	#hhp-container { }
	
	#magnetwrapper
	{
		position: absolute;
		top: 25px;
		left: 240px;
		width: 360px;
		border-top: 1px solid #eee;
		border-right: 1px solid #ccc;
		border-bottom: 1px solid #666;
		border-left: 1px solid #ccc;
		height: 490px;
		overflow: auto;
	}
	
	table#categories
	{
		border: 0;
	}
	
	table#categories col#left { width: 32px; }
	table#categories col#center { width: 32px; }
	table#categories col#right { }
	
	table#categories th, table#categories td
	{
		text-align: left;
		border: 0;
		height: 50px;
	}
	
	#fridge
	{
		width: 270px;
		height: 510px;
		background-color: #FFF;
		background-image: url('/site_media/img/fridge.png');
		position: absolute;
		top: 20px;
		right: 20px;
	}
	
	.grabber
	{
		display: block;
		width: 52px;
		height: 52px;
		cursor: move;
		z-index: 999;
	}
	
	.category-icon
	{
		display: block;
		width: 52px;
		height: 52px;
	}
	
	.eat-smart { background-image: url('/site_media/img/icon_eatsmart.png'); }
	
	.get-fit { background-image: url('/site_media/img/icon_getfit.png'); }
	
	.look-sharp { background-image: url('/site_media/img/icon_looksharp.png'); }
	
	.think-positive { background-image: url('/site_media/img/icon_thinkpositive.png'); }
	
	.ui-draggable-dragging
	{
		cursor: move;
		background-color: #f60;
	}
	
	/*.dropped { border: #f00 solid 1px; }*/
	.arrow
	{
		display: block;
		width: 18px;
		height: 18px;
	}
	
	.open { background-image: url('/site_media/img/arrow-open.png'); }
	.closed { background-image: url('/site_media/img/arrow-closed.png'); }
	.disabled { color: #ccc; }
</style>

<script type="text/javascript">
var magnets = new Array();

var positionMagnet = function(magnet,x,y) {
   var fridgeOffset = jQuery("#fridge").offset();
   fridgeOffset.left = fridgeOffset.left + x;
   fridgeOffset.top  = fridgeOffset.top + y;
   magnet.offset(fridgeOffset);
};

var saveMagnetPosition = function(id,x,y) {
   var req = new XMLHttpRequest();
   var url = "{% url health-habit-plan-save-magnet session.id %}?item_id=" + id + ";x=" + parseInt(x) + ";y=" + parseInt(y);
   req.open("POST",url,true);
   req.send(null);
};

var disableLabel = function(magnet) {
  jQuery("#item-" + magnet.attr("id").split("-")[1] + "-label").addClass("disabled");

};
</script>

{% endblock %}

{% block content %}

<div id="sessions-menu">

	<div id="sessions-add">
	<a title="create new session" href="{% url health-habit-plan-new-session %}">[+ Add Session]</a>
	</div>
	
	{% for s in sessions %}
	<div class="sessions-session">
	{% ifequal s.id session.id %}
	<span class="session-active">Session {{s.number}}</span>
	{% else %}
	<a href="{% url health-habit-plan-session s.id %}">Session {{s.number}}</a>
	<a class="delete" title="Delete" href="#">[X]</a>
	{% endifequal %}
	</div>
	{% endfor %}
	
</div>

<div id="hhp-container">

	<div id="magnetwrapper">
	<table id="categories">
	  <col id="left" />
	  <col id="center" />
	  <col id="right" />
	{% for category in categories %}
	
	<tr class="category">
	
	<td>
	<span class="arrow closed"></span>
	</td>
	
	<td>
	<span class="category-icon {{category.css}}"></span>
	</td>
	
	<th>
	{{category.label}}
	</th>
	
	</tr>
	
	{% for item in category.item_set.all %}
	    
	<tr class="item">
	
	<td>
	</td>
	
	<td>
	{% if_magnet_for_item_exists session item %}
	<!-- I guess a placeholder should go here -->
	{% else %}
	<div id="item-{{item.id}}-grabber" class="grabber {{item.category.css}}"></div>
	{% endif_magnet_for_item_exists %}
	</td>
	
	<td>
	<span id="item-{{item.id}}-label" class="{% if_magnet_for_item_exists session item %}disabled{%else%}{% endif_magnet_for_item_exists %}">{{item.label}}</span>
	</td>
	
	</tr>
	
	{% endfor %}
	
	{% endfor %}
	
	</table>
	</div>
	
	<div id="fridge"></div>
	
	{% if session.magnet_set.count %}
	{% for magnet in session.magnet_set.all %}
	<div id="item-{{magnet.item.id}}-magnet" class="magnet grabber {{magnet.item.category.css}}"></div>
	{% endfor %}
	
	<script type="text/javascript">
	jQuery(function() {
	{% for magnet in session.magnet_set.all %}    
	    positionMagnet(jQuery("#item-{{magnet.item.id}}-magnet"),{{magnet.x}},{{magnet.y}});
	{% endfor %}
	});
	</script>
	
	{% endif %}

</div>

<script type="text/javascript">

jQuery(document).ready(function(){
	jQuery('.category').click(function() {
		jQuery(this).nextUntil("tr.category").toggle();
                jQuery(this).find(".arrow").toggleClass("open");
                jQuery(this).find(".arrow").toggleClass("closed"); 
		return false;
	}).nextUntil("tr.category").hide();
});

jQuery(function() {
   jQuery(".grabber").draggable({
        revert: 'invalid'
        ,start: function(event, ui) {
           disableLabel(jQuery(this));
        }
        ,stop: function(event, ui) {
          var fridgeOffset = jQuery("#fridge").offset();
          var offset = jQuery(this).offset();
          var store_x = offset.left - fridgeOffset.left;
          var store_y = offset.top - fridgeOffset.top;
          saveMagnetPosition(jQuery(this).attr("id").split("-")[1],store_x,store_y);
        }
   });

   jQuery("#fridge").droppable({
	drop: function(event, ui) {
          jQuery(this).addClass('dropped');
	}
   }); 
});



</script>

{% endblock %}
