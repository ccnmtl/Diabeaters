{% extends 'base.html' %}

{% load hhphelpers %}

{% block js %}

<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.3/themes/base/jquery-ui.css" type="text/css" media="all" /> 
<link rel="stylesheet" href="http://static.jquery.com/ui/css/demo-docs-theme/ui.theme.css" type="text/css" media="all" /> 
<link rel="stylesheet" href="/site_media/css/healthhabitplan.css" type="text/css" media="all" />

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript" ></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.3/jquery-ui.min.js" type="text/javascript"></script>
<script src="http://jquery-ui.googlecode.com/svn/tags/latest/external/jquery.bgiframe-2.1.1.js" type="text/javascript"></script> 
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.3/i18n/jquery-ui-i18n.min.js" type="text/javascript"></script> 

<script type="text/javascript">
var magnets = new Array();

var positionMagnet = function(magnet,x,y) {
   var fridgeOffset = jQuery("#fridge").offset();
   fridgeOffset.left = fridgeOffset.left + x;
   fridgeOffset.top  = fridgeOffset.top + y;
   magnet.offset(fridgeOffset);
};

var saveMagnetPosition = function(id,x,y) {
   var req = new XMLHttpRequest();
   var url = "{% url health-habit-plan-save-magnet session.id %}?item_id=" + id + ";x=" + parseInt(x) + ";y=" + parseInt(y);
   req.open("POST",url,true);
   req.send(null);
};

var disableLabel = function(magnet) {
  jQuery("#item-" + magnet.attr("id").split("-")[1] + "-label").addClass("disabled");
  var grabber = jQuery("#item-" + magnet.attr("id").split("-")[1] + "-grabber");
  grabber.addClass("category-icon");
  grabber.removeClass("grabber");
  grabber.draggable("option", "disabled", true);
};

var deleteMagnet = function(elem) {
  var id = elem.parent().attr("id").split("-")[1];
  var magnet = jQuery("[id^=item-" + id + "].magnet");

  // delete from session
  var req = new XMLHttpRequest();
  var url = "{% url health-habit-plan-delete-magnet session.id %}?item_id=" + id;
  req.open("POST",url,true);
  req.send(null);

  // hide on fridge -- NOT using display:none so the others stay put
  magnet.css("visibility", "hidden");

  // enable in menu
  jQuery("#item-" + magnet.attr("id").split("-")[1] + "-label").removeClass("disabled");
  var grabber = jQuery("#item-" + magnet.attr("id").split("-")[1] + "-grabber");
  grabber.removeClass("category-icon");
  grabber.addClass("grabber");
  grabber.draggable("option", "disabled", false);

  // hide popup
  elem.parent().hide();
};

</script>

{% endblock %}

{% block content %}

<div id="sessions-menu">

	<div id="sessions-add">
	<a title="create new session" href="{% url health-habit-plan-new-session %}">[+ Add Session]</a>
	</div>
	
	{% for s in sessions %}
	<div class="sessions-session">
	{% ifequal s.id session.id %}
	<span class="session-active">Session {{s.number}}</span>
		<a class="delete" title="Delete" href="{% url health-habit-plan-del-session s.id %}">[X]</a>
	{% else %}
	<a href="{% url health-habit-plan-session s.id %}">Session {{s.number}}</a>
	<a class="delete" title="Delete" href="{% url health-habit-plan-del-session s.id %}">[X]</a>
	{% endifequal %}
	</div>
	{% endfor %}
	
</div>

<div id="hhp-container">

	<div id="magnetwrapper">
	<table id="categories">
	  <col id="left" />
	  <col id="center" />
	  <col id="right" />
	{% for category in categories %}
	
	<tr class="category">
	
	<td>
	<span class="arrow closed"></span>
	</td>
	
	<td>
	<span class="category-icon {{category.css}}"></span>
	</td>
	
	<th>
	{{category.label}}
	</th>
	
	</tr>
	
	{% for item in category.item_set.all %}
	    
	<tr class="item">
	
	<td>
	</td>
	
	<td>
	{% if_magnet_for_item_exists session item %}
	  <div id="item-{{item.id}}-grabber" class="grabber grabber-in-menu {{item.category.css}} grabber-disabled"></div>
	{% else %}
	<div id="item-{{item.id}}-grabber" class="grabber grabber-in-menu {{item.category.css}}"></div>
   <div id="item-{{item.id}}-popup" class="magnet-popup">
	  <div class="magnet-popup-close"></div>
	  <strong>{{item.category}}</strong><br />
	  I can beat diabetes by:<br />
	  <strong>{{item.label}}</strong>
	  <div id="item-{{item.id}}-trash" class="magnet-trash"></div>
	</div>
	{% endif_magnet_for_item_exists %}
	</td>
	
	<td>
	<span id="item-{{item.id}}-label" class="{% if_magnet_for_item_exists session item %}disabled{%else%}{% endif_magnet_for_item_exists %}">{{item.label}}</span>
	</td>
	
	</tr>
	
	{% endfor %}
	
	{% endfor %}
	
	</table>
	</div>
	
	<div id="fridge">
	
	{% if session.magnet_set.count %}
	{% for magnet in session.magnet_set.all %}
  	  <div id="item-{{magnet.item.id}}-magnet" class="magnet grabber {{magnet.item.category.css}}"></div>
	  <div id="item-{{magnet.item.id}}-popup" class="magnet-popup">
	    <div class="magnet-popup-close"></div>
	    <strong>{{magnet.item.category}}</strong><br />
	    I can beat diabetes by:<br />
	    <strong>{{magnet.item.label}}</strong>
	    <div id="item-{{magnet.item.id}}-trash" class="magnet-trash"></div>
	  </div>
	{% endfor %}
	
	</div>
	
	<script type="text/javascript">
	jQuery(function() {
	{% for magnet in session.magnet_set.all %}    
	    positionMagnet(jQuery("#item-{{magnet.item.id}}-magnet"),{{magnet.x}},{{magnet.y}});
	{% endfor %}
	});
	</script>
	
	{% endif %}

</div>

<script type="text/javascript">

jQuery(document).ready(function(){
	jQuery('.category').click(function() {
		jQuery(this).nextUntil("tr.category").toggle();
                jQuery(this).find(".arrow").toggleClass("open");
                jQuery(this).find(".arrow").toggleClass("closed"); 
		return false;
	}).nextUntil("tr.category").hide();
});

jQuery( function() {
   jQuery(".grabber").draggable({
        revert: 'invalid'
        , appendTo: '#fridge'
        , scroll: false
   });
   jQuery(".grabber-disabled").draggable("option", "disabled", true);

   // we need to use helper:clone for the divs in the menu, because otherwise
   // they can't be dragged out of the overflow:hidden (and also get 
   // hidden when the turnbuckle is closed, even if they're on the fridge)
   jQuery(".grabber-in-menu").each(function() {
     jQuery(this).draggable("option", "helper", 'clone');

     // can't use .width() and .height() before images are loaded
     var width = parseInt(jQuery(this).css('width'));
     var height = parseInt(jQuery(this).css('height'));
     jQuery(this).draggable("option", "cursorAt", {'top': height/2, 'left': width/2});
   });

   jQuery("#fridge").droppable({
     drop: function(event, ui) {
       jQuery(this).addClass('dropped');

       var item = ui.draggable;

       // if we've got a clone, we need to actually save it and put it where it belongs
       if( item.hasClass('grabber-in-menu') ) {
         // if the magnet is already on the fridge (but hidden), just re-use that one
         var magnet = jQuery("#item-" + item.attr('id').split("-")[1] + "-magnet");
         if(magnet.length > 0) {
           magnet.css('visibility', 'visible');
         }
         else {
           magnet = item.clone();
           magnet.attr("id", "item-" + magnet.attr('id').split("-")[1] + "-magnet");
           magnet.removeClass('grabber-in-menu');
           magnet.addClass('magnet');
           magnet.appendTo("#fridge");
         }

         var width = magnet.width();
         var height = magnet.height();
         magnet.offset({'top':event.pageY-height/2 , 'left':event.pageX-width/2 })
            
         magnet.draggable({
           revert: 'invalid'
           , appendTo: '#fridge'
           , scroll: 'false'
         });
         magnet.click(togglePopup);

         // take its popup label too
         var popup = jQuery("#item-" + magnet.attr('id').split("-")[1] + "-popup");
         popup.appendTo("#fridge");

         item = magnet;  // so the code below saves its position correctly
       }
       
       // save the magnet's position
       var fridgeOffset = jQuery(this).offset();
       var offset = item.offset();
       var store_x = offset.left - fridgeOffset.left;
       var store_y = offset.top - fridgeOffset.top;
       saveMagnetPosition(item.attr("id").split("-")[1],store_x,store_y);
       
       disableLabel(item);
       event.stopPropagation();
     }
   }); 
   
   jQuery(".magnet").click(togglePopup);
   
   function togglePopup() {
     // destroy any existing popups
     jQuery(".magnet-popup").hide();

     // position popup correctly
     var popup = jQuery("#item-" + jQuery(this).attr("id").split("-")[1] + "-popup");
     var windowOffsetTop = jQuery(window).scrollTop();
     var windowOffsetLeft = jQuery(window).scrollLeft();
     var fridgeOffset = jQuery("#fridge").offset()
     popup.offset({'top': jQuery(this).offset().top - fridgeOffset.top - popup.height() + windowOffsetTop + 20,
                   'left': jQuery(this).offset().left - fridgeOffset.left - popup.width() + windowOffsetLeft - 20 });
     jQuery(popup).show();
   }
   
   jQuery(".magnet-popup-close").click(function() { jQuery(this).parent(".magnet-popup").hide(); });
   jQuery(".magnet-trash").click(function() { deleteMagnet( jQuery(this) ); });
});



</script>

{% endblock %}
